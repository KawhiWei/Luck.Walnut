@using Toyar.App.Domain.AggregateRoots.ApplicationPipelines
@{

    PipelineMetaData metadata = Model;

}

pipeline {
    agent {
        kubernetes {
            defaultContainer 'jnlp'
            yaml """
apiVersion: v1
kind: Pod
metadata:
namespace: luck-infrastructure
spec:
  containers:
  @foreach (var container in metadata.Containers)
{
@:  - name: @container.ContainerName
    @:image: @container.ImageName
    @:workingDir: @container.WorkingDir
    @:command:
    @foreach (var command in container.CommandArr)
    {
    @:- @command
    }
    @:args: 
    @foreach (var command in container.ArgsArr)
    {
    @:- @command
    }
    @:tty: true
}
"""     
        }
    }
    parameters {
        @Raw(metadata.Parameter)
    }
    stages{
        @Raw(metadata.PipelineScript)
    }
    post 
    {
        always
        {
            script 
            {
                def url = "@Raw(metadata.WebHookUrl)"
                echo "Webhook URL: ${url}"

                def response = httpRequest(
                    url: url,
                    httpMode: 'PUT'
                    )
                if (response.status != 200) 
                {
                    error("Failed to call API: ${response.status} ${response.content}")
                }
                else
                {
                    echo("Success to call API: ${response.content}")
                }
            }
        }
    }
}
