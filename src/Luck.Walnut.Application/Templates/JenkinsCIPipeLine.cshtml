@using Luck.Walnut.Domain.AggregateRoots.ApplicationPipelines
@{

    PipelineMetaData metadata = Model;

}

pipeline {
    agent {
        kubernetes {
            defaultContainer 'jnlp'
            yaml """
apiVersion: v1
kind: Pod
metadata:
namespace: luck-infrastructure
spec:
  containers:
  @foreach (var container in metadata.Containers)
{
@:  - name: @container.ContainerName
    @:image: @container.ImageName
    @:workingDir: @container.WorkingDir
    @:command:
    @foreach (var command in container.CommandArr)
    {
    @:- @command
    }
    @:args: 
    @foreach (var command in container.ArgsArr)
    {
    @:- @command
    }
    @:tty: true
}
"""     
        }
    }
    parameters {
        string(name: 'BRANCH_NAME', defaultValue: 'main', description: '分支名称')
        string(name: 'VERSION_NAME', defaultValue: 'main', description: '版本号')
        string(name: 'APPLICATIONPIPELINEID', defaultValue: 'main', description: '执行流水线Id')
    }
    stages{
        @Raw(metadata.PipelineScript)
    }
}
